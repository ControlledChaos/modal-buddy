window.bp=window.bp||{},function(e,t){"undefined"!=typeof BP_Uploader&&(bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.AvatarSiteIcon={start:function(){bp.Avatar.nav.on("bp-avatar-view:changed",_.bind(this.setView,this)),this.site_icon=new Backbone.Model(_.extend(_.pick(BP_Uploader.settings.defaults.multipart_params.bp_params,"object","item_id"),BP_Uploader.settings.defaults.multipart_params.bp_params.site_icon)),bp.Avatar.Attachment.on("change:url",_.bind(this.updateSiteIcon,this))},setView:function(e){if("site_icon"===e){var t=new bp.Views.SiteIconAvatar({model:this.site_icon});bp.Avatar.views.add({id:"site_icon",view:t}),t.inject(".bp-avatar")}},updateSiteIcon:function(e){("deleted"===e.get("action")&&!0===this.site_icon.get("in_use")||"uploaded"===e.get("action")&&e.get("url")!==this.site_icon.get("src"))&&this.site_icon.set("in_use",!1)}},bp.Views.SiteIconAvatar=bp.View.extend({tagName:"div",id:"modal-buddy-site-icon",template:bp.template("modal-buddy-site-icon"),events:{"click .avatar-crop-submit":"setAvatar"},initialize:function(){bp.Avatar.displayWarning(!0===this.model.get("no_icon")?BP_Uploader.strings.site_icon.noIcon:!0===this.model.get("in_use")?BP_Uploader.strings.site_icon.inUse:BP_Uploader.strings.site_icon.explain)},setAvatar:function(e){var i=this;if(e.preventDefault(),!_.isUndefined(bp.Avatar.views.get("site_icon"))){var a=bp.Avatar.views.get("site_icon");a.get("view").remove(),bp.Avatar.views.remove({id:"site_icon",view:a})}return wp.ajax.post("modal_buddy_use_site_icon",{item_id:i.model.get("item_id"),item_object:i.model.get("object"),site_icon:i.model.get("id"),nonce:i.model.get("nonce")}).done(function(e){i.model.set("in_use",!0);var a=new bp.Views.AvatarStatus({value:BP_Uploader.strings.site_icon[e.feedback_code],type:"success"});bp.Avatar.views.add({id:"status",view:a}),a.inject(".bp-avatar-status"),t("."+i.model.get("object")+"-"+i.model.get("item_id")+"-avatar").each(function(){t(this).prop("src",i.model.get("src"))}),bp.Avatar.navItems.get("delete").set({hide:0}),bp.Avatar.Attachment.set(_.extend(_.pick(i.model.attributes,["object","item_id"]),{url:i.model.get("src"),action:"uploaded"}))}).fail(function(e){var t=new bp.Views.AvatarStatus({value:BP_Uploader.strings.site_icon[e.feedback_code],type:"error"});bp.Avatar.views.add({id:"status",view:t}),t.inject(".bp-avatar-status")})}}),bp.AvatarSiteIcon.start())}(bp,jQuery);